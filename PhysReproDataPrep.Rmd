---
title: "PhysReproDataPrep"
author: "Ashlee Mikkelsen"
date: "`r Sys.Date()`"
output: word_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

This Rmarkdownd will go through data prep for analysis of the physiological indicators of reproduction in brown bears (*Ursus arctos arctos*) in Sweden

```{r load packages, include=FALSE}
# clear workspace and load packages
rm(list = ls())
setwd("~/Rprojects/Diet-and-reproduction-in-rown-bears")

library(readxl)
library(dplyr)
library(ggplot2)
library(viridis)
library(tidyverse)

```

```{r load data, include=FALSE}

rawdata <- read_excel("RawBearData_SI_CORT.xlsx")
str(rawdata)


```

So I have my raw data loaded and it needs a lot of work to be usable for analysis. I need to correct the cortisol for the difference between extraction kits. I need to correct the 13C for the Suess effect, I need to extract the females from this files and I need to determine how many NAs are present and what to do with them. Do I remove them or do I populate their missing data?

### Data Cleanup
I need remove quantify the records with missing values. 149 females do not have cortisol values and of these, 35 are missing stable isotope data. For now, let's remove these.
```{r remove NAs}

bears.fem <- subset(rawdata, reprostatus.represent!="SolitaryM")
bears.fem.cort <- subset(bears.fem, cortisol!="NA")
bears.fem.cort.si <- subset(bears.fem.cort, N15!="NA")


```


I guess the first step will be correcting the cortisol. This means that I need to use the equation published in Wilson et al. 2021. While this analysis focuses on females, it also includes cubs-yearlings, which include males. Therefore the general cortisol correction is ideal

$$
cortisol from kit 2 = 1.65 + (0.98 * cortisol from kit 1)
$$

```{r isolate females and correct cortisol}

kit <- bears.fem.cort.si$cort.kit
print(kit)
cort.raw <- as.numeric(bears.fem.cort.si$cortisol)
cort.corrected <-as.numeric(rep(0,length(kit)))

df <-as.data.frame(cbind("kit"=kit, "cort.raw"=as.numeric(cort.raw), "cort.corrected"=as.numeric(cort.corrected)))
df$cort.raw <- as.numeric(df$cort.raw)
df$cort.corrected <- as.numeric(df$cort.corrected)

str(df)
print(df[2,2])


kit1correction <- function(x,y){
  y=1.65+(0.98*x)
}

kit2correction <- function(x,y){
  y=(x*1)
}

for (i in 1:length(df[,1])) {
  if(df[i,1]=="1"){
    df[i,3] <- kit1correction(df[i,2])
  } else {
    df[i,3] <- kit2correction(df[i,2])
  }
}

bears.fem.cort.si$cortisol.kitcorrected <- df$cort.corrected

```

The next step is to correct the ð›…13C values for the Suess effect due to human burning of fossil fuels. Following Chamerlain *et al.* 2005, I use a time-dependent correction of -0.022â€° for each year up to the last year in my data set.

```{r}

LastYr <- as.numeric(max(bears.fem.cort.si$year.represent))
bears.fem.cort.si$year.represent <- as.numeric(bears.fem.cort.si$year.represent)
bears.fem.cort.si$C13 <- as.numeric(bears.fem.cort.si$C13)

C13.suess <- bears.fem.cort.si$C13-(-0.022*(LastYr-bears.fem.cort.si$year.represent))
bears.fem.cort.si$C13.suess <- C13.suess


```


It looks like there are a few more housekeeping issues to address. A common metric of body condition is mass or mass scaled by a body measurement. In this case, we have mass and head circumference. I will create a body condition metric based on these two measurements

```{r}
bears.repro <- subset(bears.fem.cort.si, reprostatus.represent!="NA")
bears.repro$N15 <- as.numeric(bears.repro$N15)

bears.repro$weight <- as.numeric(bears.repro$weight)
bears.repro$headcirc <- as.numeric(bears.repro$headcirc)
bears.repro$condition <- bears.repro$weight/bears.repro$headcirc
# Bears will have a higher body condition index as the ratio between head circumference, which is a good measure of the overall skeletal size, and their mass increases. For example, a bear with really high mass and a small head means they are a smaller bear with greater fet reserves, muscle mass, or organs. All three of these equate to plentiful resource availability

bear.reprodata <- bears.repro %>%
  rename(
    repro=reprostatus.represent,
    year=year.represent,
    bearyear=bearyear.represent,
    cort= cortisol.kitcorrected,
    mass=weight
  )


```


Finally, we save our datafile

```{r}

write.csv(bear.reprodata,"bearreprodata.csv")
```

One of the main tenants of this analysis is how N15 and cortisol are going to change with reproductive status and between family groups

So we graph N15 by repro group

```{r}

ggplot(data = bear.reprodata, aes(repro, N15))+
  geom_jitter(aes(color=repro), alpha=0.4, width = 0.05)+
  geom_violin(aes(group=repro, fill=repro), alpha=0.3)+
  scale_color_viridis(discrete = TRUE)+
  scale_fill_viridis(discrete = TRUE)+
  theme_classic()

```

we graph N15 by cort

```{r}

ggplot(data = bear.reprodata, aes(N15, cort))+
  geom_point(alpha=0.5)+
  theme_classic()


```



and we graph both N15 and cort by year
```{r}
ggplot(data = bear.reprodata, aes(year,N15))+
  geom_jitter(width = 0.01, alpha=0.6,size=3)+
  theme_classic()+
  scale_color_viridis(discrete = TRUE)
# Well, this is weird

ggplot(data = bear.reprodata, aes(year, cort))+
  geom_jitter(width = 0.1, alpha=0.6, size=3)+
  theme_classic()

```


I expect that cort and N15 should be related to body condition, so we have both weight and head circumference.
```{r}







```

