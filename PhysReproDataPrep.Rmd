---
title: "PhysReproDataPrep"
author: "Ashlee Mikkelsen"
date: "`r Sys.Date()`"
output: word_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

This Rmarkdownd will go through data prep for analysis of the physiological indicators of reproduction in brown bears (*Ursus arctos arctos*) in Sweden

```{r load packages, include=FALSE}
# clear workspace and load packages
rm(list = ls())


library(readxl)
library(dplyr)
library(ggplot2)
library(viridis)

```

```{r load data, include=FALSE}

rawdata <- read_excel("RawBearData_SI_CORT.xlsx")
str(rawdata)


```

So I have my raw data loaded and it needs a lot of work to be usable for analysis. I need to correct the cortisol for the difference between extraction kits. I need to correct the 13C for the Suess effect, I need to extract the females from this files and I need to determine how many NAs are present and what to do with them. Do I remove them or do I populate their missing data?

### Data Cleanup
I need remove quantify the records with missing values. 149 females do not have cortisol values and of these, 35 are missing stable isotope data. For now, let's remove these.
```{r remove NAs}

bears.fem <- subset(rawdata, sex=="F")
bears.fem.cort <- subset(bears.fem, cortisol!="NA")
bears.fem.cort.si <- subset(bears.fem.cort, N15!="NA")


```


I guess the first step will be correcting the cortisol. This means that I need to use the equation published in Wilson et al. 2021. Now this analysis is focused only on females, so I guess it actually makes more sense to first isolate females, then apply the female specific correction rather than the general correction to my data.

$$
cortisol from kit 2 = 1.98 + (0.89 * cortisol from kit 1)
$$

```{r isolate females and correct cortisol}

kit <- bears.fem.cort.si$cort.kit
print(kit)
cort.raw <- as.numeric(bears.fem.cort.si$cortisol)
cort.corrected <-as.numeric(rep(0,472))

df <-as.data.frame(cbind("kit"=kit, "cort.raw"=as.numeric(cort.raw), "cort.corrected"=as.numeric(cort.corrected)))
df$cort.raw <- as.numeric(df$cort.raw)
df$cort.corrected <- as.numeric(df$cort.corrected)

str(df)
print(df[2,2])


kit1correction <- function(x,y){
  y=1.98+(0.89*x)
}

kit2correction <- function(x,y){
  y=(x*1)
}

for (i in 1:length(df[,1])) {
  if(df[i,1]=="1"){
    df[i,3] <- kit1correction(df[i,2])
  } else {
    df[i,3] <- kit2correction(df[i,2])
  }
}

bears.fem.cort.si$cortisol.kitcorrected <- df$cort.corrected

```

The next step is to correct the ð›…13C values for the Suess effect due to human burning of fossil fuels. Following Chamerlain *et al.* 2005, I use a time-dependent correction of -0.022â€° for each year up to the last year in my data set.

```{r}

LastYr <- as.numeric(max(bears.fem.cort.si$year.represent))
bears.fem.cort.si$year.represent <- as.numeric(bears.fem.cort.si$year.represent)
bears.fem.cort.si$C13 <- as.numeric(bears.fem.cort.si$C13)

C13.suess <- bears.fem.cort.si$C13-(-0.022*(LastYr-bears.fem.cort.si$year.represent))
bears.fem.cort.si$C13.suess <- C13.suess

```


