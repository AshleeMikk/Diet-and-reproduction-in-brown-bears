---
title: "BearReproHypothesis2_Bayes_STAN"
author: "Ashlee Mikkelsen"
date: "2022-11-24"
output: word_document
toc: true
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = FALSE)

```

# Introduction

Because the repro data is so messy and confusing and irritating, I have taken Anne's advice and instead of using GLMMs for my initial modelling, I am going to use the package brms and STAN to analyze my models because I was having convergence and singularity issues with lme4. For details on the background and development of hypotheses and individual relationships, see:

C:\Users\amikk\Documents\Rprojects\Diet-and-reproduction-in-rown-bears\Hypothesis2\BearReproHypotheis2\_Freq.RMD

From here, I will be continuing from the mid-point in that analysis, as the frequentist version has become quite messy.

The steps for this version of step 1 (there are several predecessors) are as follows:

1.  Determine the best supported non-linear relationships for covariates that I had hypothesized may be non-linear, such as age, body condition, and $\delta^{15}N$

2.  create univariate models with cortisol as the response variable to determine which of my covariates have support in the data to explain variation in cortisol across individuals. This will help with the interpretation of the PCA and PLSR as well as serve for interesting comparisons.

# Setup

## load data and packages

```{r, include=FALSE}
rm(list=ls())
setwd("~/Rprojects/Diet-and-reproduction-in-rown-bears/Hypothesis2")


library(ggplot2)
library(wiqid)
library(rstan)
library(brms)
library(viridis)
library(patchwork) # for multi-panel plots
library(gridExtra)

```

## set graphing theme

```{r, include=FALSE}

mytheme <- theme(
    axis.text = element_text(size = 12,face = "bold"),
    axis.title = element_text(size = 14, face = "bold"),
    panel.grid.major = element_line(color = "grey92"),
    panel.grid.minor = element_line(color = "grey96"),
    panel.background = element_rect(fill = "white"),
    axis.line = element_line(colour = "black",size = 1),
    axis.ticks = element_line(size = 1),
    )
theme_set(mytheme)

```

## Load Data

```{r, include=FALSE}

HP2.dat <- read.csv("BearReproData_H2Analysis.csv")

Cort.Repro <- HP2.dat[,c(1,3,6,10,11,12,13,14,15,16,22,23,26,28)]
Cort.Repro <- subset(Cort.Repro, reprocat!="Wmother")
Cort.Repro$bearID<-as.factor(Cort.Repro$bearID)

PP <- palette(viridis(13))
PP <- palette(viridis(13))

```

```{r, include=FALSE}

### Convert ILI from cat. variable to a continuous one

fILI= Cort.Repro$ILI

cILI=rep(0,length(fILI))

for(i in 1:273){
  if(fILI[i]=="O"){
    cILI[i]=1
  }else if (fILI[i]=="TW"){
    cILI[i]=2
  }else if (fILI[i]=="TH"){
    cILI[i]=3
  }else if (fILI[i]== "FR"){
    cILI[i]=4
  }else if (fILI[i]=="FV"){
    cILI[i]=5
  }
}
cILI

Cort.Repro$cILI= cILI

colSums(is.na(Cort.Repro))

Cort.Repro$lnCORT <- log(Cort.Repro$cort)

```

## Covarite variation for determining non-linear relationships
```{r, include=FALSE}

Cort.Repro$N15sq <- Cort.Repro$N15^2
Cort.Repro$N15ln <- log(Cort.Repro$N15)

Cort.Repro$conditionsq <- Cort.Repro$condition^2
Cort.Repro$conditionln <- log(Cort.Repro$condition)

Cort.Repro$age2<-Cort.Repro$age^2
Cort.Repro$ageln<-log(Cort.Repro$age)

Cort.Repro$cortln <- log(Cort.Repro$cort)
Cort.Repro$cortsq <- Cort.Repro$cort^2


```

## Z-transform continuous covariates

```{r, include=FALSE}
Cort.Repro$ageln<-log(Cort.Repro$age)
Cort.Repro$fYR <- as.factor(Cort.Repro$year)
Cort.Repro$Zage <- standardize(Cort.Repro$age)
Cort.Repro$Zagesq <- standardize(Cort.Repro$age2)
Cort.Repro$Zageln <- standardize(Cort.Repro$ageln)
Cort.Repro$Zlitsize <- standardize(Cort.Repro$cubsfirstcount)
Cort.Repro$Zd13C <- standardize(Cort.Repro$C13.suess)
Cort.Repro$Zd15N <- standardize(Cort.Repro$N15)
Cort.Repro$Zd15Nsq <- standardize(Cort.Repro$N15sq)
Cort.Repro$Zd15Nln <- standardize(Cort.Repro$N15ln)
Cort.Repro$Zcond <- standardize(Cort.Repro$condition)
Cort.Repro$Zcondsq <- standardize(Cort.Repro$conditionsq)
Cort.Repro$Zcondln <- standardize(Cort.Repro$conditionln)
Cort.Repro$Zcort <- standardize(Cort.Repro$cort)
Cort.Repro$Zcortln <- standardize(Cort.Repro$cortln)
Cort.Repro$Zcortsq <- standardize(Cort.Repro$conditionsq)
Cort.Repro$ZcILI <- standardize(Cort.Repro$cILI)
Cort.Repro$LMC <- as.factor(Cort.Repro$weaningage)
Cort.Repro$Parity <- as.factor(Cort.Repro$statut)


```


# Determine best distribution to use: Gaussian or Gamma

## Cortisol distribution

```{r, fig.height=5, fig.width=8, fig.cap="Cortisol distributions untransformed (panel A) and with the natural log transformation (panel B) "}

ggplot(data = Cort.Repro, aes(cort))+
  geom_histogram(binwidth = sd(Cort.Repro$cort)*0.5,
                 fill=PP[4])+
  scale_y_continuous(expand = c(0,0))+
  scale_x_continuous(expand = c(0,0))+
  geom_text(label="A",
            size=4,
            x=30, y=89)+
  
  ggplot(data = Cort.Repro, aes(lnCORT))+
  geom_histogram(binwidth = sd(Cort.Repro$lnCORT)*0.5,
                 fill=PP[5])+
  scale_y_continuous(expand = c(0,0))+
  scale_x_continuous(expand = c(0,0))+
  xlab("ln ( Cortisol)")+
  ylab("")+
  geom_text(label="B",
            size=4,
            x=3.35, y=52)
  

```


The distribution of our cortisol is highly left-skewed and positive. I will need to either use a Gaussian model with a log-link or a gamma distribution with a log link.


### Intercept only model
```{r, include=FALSE, eval=FALSE}

CORTint.gauss<- brm(cort ~1+(1|fYR)+(1|bearID),
               data = Cort.Repro,
               family = gaussian(link = "log"),
              iter = 6000,
              thin = 10)
summary(CORTint.gauss)
options(mc.cores = 1)
fit1 <- add_criterion(CORTint.gauss, criterion = "loo")
gc()
print(fit1$criteria$loo)
Gaussian.LOOic <- fit1$criteria$loo$estimates[3,1]

CORTint.gamma<- brm(cort ~1+(1|fYR)+(1|bearID),
               data = Cort.Repro,
               family = Gamma(link = "log"),
              iter = 6000,
              thin = 10)
summary(CORTint.gamma)
options(mc.cores = 1)
fit2 <- add_criterion(CORTint.gamma, criterion = "loo")
gc()
print(fit2$criteria$loo)

Gamma.LOOic <- fit2$criteria$loo$estimates[3,1]



```

The gamma model with the log link, with only the intercept and random effects of bearID and year performed better than the gaussian model. Therefore, all future models will be run with a gamma distribution and a log link.

The underlying models can be expressed as


$$Y_i\sim{\sf Gamma}(\alpha_j,\beta)$$
$$\alpha_j = \mu_i/\beta$$
$$\mu_i = x_i*\gamma$$

The linear combination can be written as

$$E(\mu(Y_i))=e^{\beta_0+\beta_1x_1+\beta_2x_2...\beta_ix_i}$$
## Nitrogen distribution

```{r, fig.height=5, fig.width=8, fig.cap="Nitrogen distribution"}

ggplot(data = Cort.Repro, aes(N15))+
  geom_histogram(binwidth = sd(Cort.Repro$N15)*0.5,
                 fill=PP[8])+
  scale_y_continuous(expand = c(0,0))+
  scale_x_continuous(expand = c(0,0))
  

```

Unlike cortisol, $\delta^{15}N$ distribution is close enough to a normal distribution to use the Gaussian distribution 

# Cortisol as a response variable

## Side bar 1: Litter variables

Litter CORT and litter condition are missing too many records to include, but did have some interesting implications, so quickly I examine them on their own

```{r, echo=FALSE, include=FALSE}

side.bar1 <- HP2.dat[,c(1,3,6,10,11,12,13,14,15,16,22,23,26,28,29,30)]
side.bar1 <- subset(side.bar1, reprocat!="Wmother")
side.bar1 <- subset(side.bar1,littercort!="NA")
side.bar1 <- subset(side.bar1,littercond>0)

side.bar1$lnLCORT <- log(side.bar1$littercort)
side.bar1$lnMCORT <- log(side.bar1$cort)

SB.NumVar1 <- side.bar1[,c(2,3,5,11,12,13,14,15,16)]

```



```{r, include=FALSE, echo=FALSE}

P1 <- ggplot(data = side.bar1, aes(condition, littercond))+
  geom_point()+
  ylab("Litter Condition")+
  xlab("Maternal Condition")+
  geom_smooth(method = "lm")+
  scale_y_continuous(expand=c(0,0))+
  scale_x_continuous(expand = c(0,0))+
  geom_text(label="1",
            size=7,
            x=1.7, y=0.8,
            color="blue2")
  
P1

P2 <- ggplot(data = side.bar1, aes(cort, littercort))+
  geom_point()+
  ylab("Litter Cortisol")+
  xlab("Maternal Cortisol")+
  geom_smooth(method = "lm")+
  scale_y_continuous(expand=c(0,0))+
  scale_x_continuous(expand = c(0,0))+
  geom_text(label="2",
            size=7,
            x=25, y=18.5,
            color="blue2")

P2

P2.5 <- ggplot(data = side.bar1, aes(lnMCORT, lnLCORT))+
  geom_point()+
  ylab("ln (Litter Cortisol)")+
  xlab("ln (Maternal Cortisol)")+
  geom_smooth(method = "lm")+
  scale_y_continuous(expand=c(0,0))+
  scale_x_continuous(expand = c(0,0))+
  geom_text(label="2",
            size=7,
            x=25, y=18.5,
            color="blue2")
P2.5


P3 <- ggplot(data = side.bar1, aes(condition, littercort))+
  geom_point()+
  geom_smooth(method = "lm")+
  ylab("Litter CORT")+
  xlab("Maternal condition")+scale_y_continuous(expand=c(0,0))+
  scale_x_continuous(expand = c(0,0))+
  geom_text(label="3",
            size=7,
            x=1.8, y=15,
            color="blue2")


P4 <- ggplot(data = side.bar1, aes(cort, littercond))+
  geom_jitter(width=0.15)+
  geom_smooth(method = "lm")+
  ylab("Litter Condition")+
  xlab("Maternal Cortisol")+
  scale_y_continuous(expand=c(0,0))+
  scale_x_continuous(expand = c(0,0))+
  geom_text(label="4",
            size=7,
            x=25, y=0.8,
            color="blue2")



```



```{r, include=TRUE, fig.height=7, fig.width=8, echo=FALSE, fig.cap="Combinations of regressions between maternal cortisol, maternal condition, litter cortisol, and litter condition"}
P14 <- grid.arrange(P1,P2,P3,P4, ncol=2)
```


We can see in panels 1 & 2 that both condition and cortisol are
correlated between female bears and their litter. This is something we
would expect, but it is good to see the assumption holds true. But we
also see that there are some instances of females with high body
condition and relatively low litter condition. There are some
interesting things here that are worth returning to and exploring. Maybe
a bit about maternal trade-offs.

We see in panel 3 that litter cortisol is negatively correlated with
maternal condition, which means females in poorer condition tend to have
offspring with higher average cortisol values. In addition, in panel 4,
we see that females with lower cortisol tend to have litters in better
condition that females with higher cortisol.

```{r, include=FALSE}
Year.cort <- subset(HP2.dat, reprocat=="Wmother")

P5 <- ggplot(data = Year.cort, aes(year,cort))+
  geom_jitter(width = 0.15, size=2, alpha=0.5)+
  ylab("Offspring cortisol")+
  scale_x_continuous(limits = c(1995,2015))


P6 <- ggplot(data = side.bar1, aes(year,cort))+
  geom_jitter(width = 0.15, size=2, alpha=0.5)+
  ylab("Maternal Cortisol")+
  scale_x_continuous(limits = c(1995,2015))
```

```{r, include=TRUE, fig.height=5, fig.width=7.5, echo=FALSE, fig.cap="annual trend in maternal and average cortisol in a given litter"}

P56 <- grid.arrange(P5,P6, ncol=2)

```

This is VERY interesting. There is a clear increase in cortisol over
time in both females and their litters. The increase for litters looks
exponential, while females have maybe linear/exponential increases. I
would love to get my hands on the last several years of data to see if
this trend continues.


```{r, include=FALSE}
rm(P1,P2,P3,P4,P5,P6, P14,P56,
   SB.NumVar1,side.bar1,Year.cort,
   cILI,fILI,i)

```


## Covariates and explanations of hypothesized relationships

Below I explain and model hypothesized non-linear relationships between cort and covariates. The actual model code and output has been suppressed, but all models were run in a Bayesian framework using package brms and STAN for 6000 iterations and a thinning rate of 10. Model comparisons were done using the leav-one-out cross-validation method and commparing the LOOic vaues, as well as examining the regression $\beta$ estimates and determining the extent that 95% credible intervals overlapped zero.

### d15N

Cortisol and diet are intimately tied together, as bears with higher
diet quality and quantity can sustain higher energetic demands before
reaching a physiological emergency state. As reproduction is extremely
energetically demanding, I expect two different relationships. In the
first scenario, bears with high cortisol have low $\delta^{15}N$ signatures, which indicates relatively lower intake of high-protein foods. Cortisol will
decrease with increasing protein-rich foods, but may increase linearly
or in a non-linear way. Cortisol may decrease slowly at first until a
certain threshold is reached, after which it decreases rapidly.
Conversely cortisol may rapidly decrease with greater protein
consumption until protein demands are met and the benefit of ingesting
protein tapers off. In the second scenario, the relationship between
cortisol and $\delta^{15}N$ is quadratic, where bears with diets less protein have moderate cortisol concentrations, which decrease and d15N increases to
median levels. Beyond the median $\delta^{15}N$ concentration, cortisol increases. This relationship may have different mechanisms. One may be related to high $\delta^{15}N$ signatures related to muscle breakdown that results from
protein deficiency and starvation. The second results from increased metabolic demands in bears who consume an excess of protein and must burn energy to excrete the nitrogen and dissipate excess heat.

To model these relationships, I will need to use higher order or
ln-transformed $\delta^{15}N$ values to determine which relationship best fits the data, then include only that term in the final model.

```{r, include=FALSE, eval=FALSE}

##### Linear
Lin15N.gamma<- brm(cort ~Zd15N+(1|fYR)+(1|bearID),
               data = Cort.Repro,
               family = Gamma(link = "log"),
              iter = 3000)
summary(Lin15N.gamma)
options(mc.cores = 1)
fit3 <- add_criterion(Lin15N.gamma, criterion = "loo")
gc()
print(fit3$criteria$loo)
Lin15N.LOOic <- fit3$criteria$loo$estimates[3,1]


##### Log-Linear

Log15N.gamma<- brm(cort ~Zd15Nln+(1|fYR)+(1|bearID),
               data = Cort.Repro,
               family = Gamma(link = "log"),
              iter = 3000)
summary(Log15N.gamma)
options(mc.cores = 1)
fit4 <- add_criterion(Log15N.gamma, criterion = "loo")
gc()
print(fit4$criteria$loo)
Log15N.LOOic <- fit4$criteria$loo$estimates[3,1]

##### Quadratic

Quad15N.gamma<- brm(cort ~Zd15N+Zd15Nsq+(1|fYR)+(1|bearID),
               data = Cort.Repro,
               family = Gamma(link = "log"),
              iter = 6000,
              thin = 10)
summary(Quad15N.gamma)
options(mc.cores = 1)
fit5 <- add_criterion(Quad15N.gamma, criterion = "loo")
gc()
print(fit5$criteria$loo)
Quad15N.LOOic <- fit5$criteria$loo$estimates[3,1]


```



```{r, include=FALSE, eval=FALSE}
print(Gamma.LOOic)
print(Lin15N.LOOic)
print(Log15N.LOOic)
print(Quad15N.LOOic)

summary(Log15N.gamma)
summary(Lin15N.gamma)


d15N.LOOic.Table <-c(Log15N.LOOic,Lin15N.LOOic,Quad15N.LOOic,Gamma.LOOic)

d15N.LOOic.Table <- data.frame(d15N.LOOic.Table)
names(d15N.LOOic.Table)[1] <- "LOOic"
d15N.LOOic.Table$Model <- c("d15N.log",
                            "d15N.Linear",
                            "d15N.Quad",
                            "Gamma.Intercept")

```


```{r, include=FALSE,eval=FALSE}

knitr::kable(d15N.LOOic.Table)

```


According to the bayesian gamma models, the log-linear relationship is better than the linear and the quadratic and it is much better than the intercept only model. Therefore, this is the one I will retain. Mathematically:

$$E(\mu(cortisol))= e^{(1.74+(-0.10*ln(\delta^{15}N))}$$

However, the log-linear relationship was only slightly better than the linear relationship, and the graph shows a relationship with only a vague change in slope across the values of $\delta^{15}N$

### Maternal body condition

The simplest relationship between maternal condition (mass/head circumference) and maternal cortisol concentration would be a linear decrease in cortisol as body condition increases. This insinuates that females in better condition are under fewer metabolic demands and maintain low cortisol concentrations. In addition, the relationship between maternal body condition and maternal cortisol may be log-linear. We may see high cortisol associated with low body condition, which decreases to median body conditions, where it becomes stable. We may also see two different quadratic relationships. One would open upward and indicate a stabilizing selective relationship in which bears with median body conditions also have low cort levels. Bears with body conditions below the median may be under environmental stresses and greater energetic demands, while bears above the median body condition may be incurring an energetic cost to maintain greater fat or muscle mass. If the quadratic relationship opens downwards, females in poor condition would have low cort, related to HPA exhaustion or down regulation, perhaps related to reproduction, and cort would increase to median body conditions, beyond which the cost of maintaining greater fat and lean mass may incur an energetic cost.

```{r, include=FALSE, eval=FALSE}

##### Linear
LinCon.gamma<- brm(cort ~Zcond+(1|fYR)+(1|bearID),
               data = Cort.Repro,
               family = Gamma(link = "log"),
              iter = 3000)
summary(LinCon.gamma)
options(mc.cores = 1)
fit1 <- add_criterion(LinCon.gamma, criterion = "loo")
gc()
print(fit1$criteria$loo)
LinCon.LOOic <- fit1$criteria$loo$estimates[3,1]


##### Log-Linear

LogCon.gamma<- brm(cort ~Zcondln+(1|fYR)+(1|bearID),
               data = Cort.Repro,
               family = Gamma(link = "log"),
              iter = 3000)
summary(LogCon.gamma)
options(mc.cores = 1)
fit2 <- add_criterion(LogCon.gamma, criterion = "loo")
gc()
print(fit2$criteria$loo)
LogCon.LOOic <- fit2$criteria$loo$estimates[3,1]

##### Quadratic

QuadCon.gamma<- brm(cort ~Zcond+Zcondsq+(1|fYR)+(1|bearID),
               data = Cort.Repro,
               family = Gamma(link = "log"),
              iter = 6000,
              thin = 10)
summary(QuadCon.gamma)
options(mc.cores = 1)
fit3 <- add_criterion(QuadCon.gamma, criterion = "loo")
gc()
print(fit3$criteria$loo)
QuadCon.LOOic <- fit3$criteria$loo$estimates[3,1]


```


```{r, include=FALSE, eval=FALSE}

print(Gamma.LOOic)
print(LinCon.LOOic)
print(LogCon.LOOic)
print(QuadCon.LOOic)

Gamma.LOOic-QuadCon.LOOic

summary(QuadCon.gamma)
```

The quadratic relationship between body condition and cortisol had the most support and performed better than the intercept only model.


$$E(\mu(cortisol))= e^{(1.74+(0.67*cond)+(-0.65*cond^2))}$$


### Maternal age

It doesn't really make
physiological sense for cortisol to continuously increase through life.
It seems more likely that it may increase and then decrease in a
quadratic relationship or increase to a certain age and then plateau.Young bears have lots of energetic demands. They grow rapidly the first few years, disperse through a potentially hostile environment, and then must settle in an unknown place and learn to be fully independent build social relationships, and begin reproducing for the first time. Eventually, bears should be settled within their home ranges with predictable variations in food resources and familiar neighboring bears (debatable).

```{r, include=FALSE}

rm(fit1,fit2,fit3,
   LogCon.gamma,QuadCon.gamma, LinCon.gamma)


```


```{r, include=FALSE, eval=FALSE}

##### Linear
LinAge.gamma<- brm(cort ~Zage+(1|fYR)+(1|bearID),
               data = Cort.Repro,
               family = Gamma(link = "log"),
              iter = 3000)
summary(LinAge.gamma)
options(mc.cores = 1)
fit1 <- add_criterion(LinAge.gamma, criterion = "loo")
gc()
print(fit1$criteria$loo)
LinAge.LOOic <- fit1$criteria$loo$estimates[3,1]


##### Log-Linear

LogAge.gamma<- brm(cort ~Zageln+(1|fYR)+(1|bearID),
               data = Cort.Repro,
               family = Gamma(link = "log"),
              iter = 6000,
              thin = 10)
summary(LogAge.gamma)
options(mc.cores = 1)
fit2 <- add_criterion(LogAge.gamma, criterion = "loo")
gc()
print(fit2$criteria$loo)
LogAge.LOOic <- fit2$criteria$loo$estimates[3,1]

##### Quadratic

QuadAge.gamma<- brm(cort ~Zage+Zagesq+(1|fYR)+(1|bearID),
               data = Cort.Repro,
               family = Gamma(link = "log"),
              iter = 6000,
              thin = 10)
summary(QuadAge.gamma)
options(mc.cores = 1)
fit3 <- add_criterion(QuadAge.gamma, criterion = "loo")
gc()
print(fit3$criteria$loo)
QuadAge.LOOic <- fit3$criteria$loo$estimates[3,1]


```


```{r, include=FALSE, eval=FALSE}

print(Gamma.LOOic)
print(LinAge.LOOic)
print(LogAge.LOOic)
print(QuadAge.LOOic)

Gamma.LOOic-QuadAge.LOOic

summary(QuadAge.gamma)

```

The quadratic relationship between age and cortisol had the most support and performed better than the intercept only model.

$$E(\mu(cortisol))= e^{(1.75+(0.49*age)+(-0.39*age^2))}$$

## Non-linear summary

$\delta^{15}N$ signatures were best modeled by a linear relationship with brown bear hair cortisol. Technically, the log-linear relationship was **VERY** slightly better than the linear, but the difference was so small that I chose to retain the simpler, linear relationship rather than the log-linear one. Meanwhile condition and age were best modeled with the quadratic relationship.

## Hypothesized linear relationships

### CORT- years since last litter

I expect that the cortisol will be highest one year after their last birth, as offspring have the highest dependence on females during that time. It should bee lower when it has been 2 years since the last littler, then increase again.

### CORT- Litter size.

Cort should be greater with larger litter sizes, as caring for more
young should have a higher energetic cost.

### CORT- Length Maternal Care

I expect length of maternal care to either increase with cortisol, as
bears under more energetic demands may need a longer period to fully
grow. Conversely, females under energetic demands may separate from
their cubs earlier to preserve their own condition. As a result, there
may be an interaction between cortisol and length of maternal care.

### CORT- parity

young, inexperienced mothers typically have lower success, therefore I
expect primiparous bears to have higher cortisol than multiparous bears

### CORT-year

I expect cortisol to vary annually with many unmeasured environmental
variables. Because I do not have a complete time series and likely have
missing data across years, I have to make the effect of year categorical
rather than continuous.

### CORT- Bear ID

Because I have repeated measures on bears, I expect cortisol across
years to be more similar within the same bear than between bears.
However, I do expect the above covariates to affect the cortisol of the
same bear sampled over many years.


## Interpretations of univariate models

### Most intriguing results

#### d15N

```{r, include=FALSE}

d15N.model <- function(x){
  exp(1.74+(x*-0.10))
}

new.d15N <- seq(min(Cort.Repro$Zd15Nln), max(Cort.Repro$Zd15Nln),
                length.out=100)

dN15.predcort <- d15N.model(new.d15N)
Ad15N <- (new.d15N*sd(Cort.Repro$N15ln))+mean(Cort.Repro$N15ln)
UnLog.Ad15N <- exp(Ad15N)
d15N.df <- as.data.frame(cbind(new.d15N, dN15.predcort,UnLog.Ad15N))


```


```{r, fig.height=5, fig.width=5, fig.cap="Fitted relationship with observed values as points"}

ggplot(data = d15N.df, aes(UnLog.Ad15N, dN15.predcort))+
  geom_jitter(data = Cort.Repro, aes(N15,cort),
              alpha=0.5,
              width = 0.01, 
              height =0.05,
              size=3)+
  geom_line(lwd=1.2)+
  ylab("Cortisol")+
  xlab(expression(paste(delta^15, "N (\u2030)", sep = "")))+
  geom_text(label="beta (N) = - 0.10, SE= 0.03\n delta LOOaic = 19.1 ",
            x=4, y=25, size=4)
```
From this we see that bears with higher $\delta^{15}N$ concentrations are associated with greater consumption of protein-rich foods, such as ants and moose.

```{r,echo=FALSE,fig.height=7, fig.width=8, fig.cap="Relationships between nitrogen and head circumference and age, with a fitted relationship"}

ggplot(data = subset(HP2.dat, reprocat!="Wmother"), aes(headcirc, N15))+
  geom_jitter(width=0.2, alpha=0.7)+
  ylab(expression(paste(delta^15, "N (\u2030)", sep = "")))+
  xlab(" Head circumference (cm)")+
  geom_smooth(method = "lm")+
  scale_y_continuous(expand = c(0,0))+
  scale_x_continuous(expand = c(0,0))+
  
  
ggplot(data = Cort.Repro, aes(age,N15))+
  geom_jitter(width = 0.2)+
  geom_smooth(method = "lm")+
  scale_y_continuous(expand = c(0,0))+
  scale_x_continuous(expand = c(0,0))+
  ylab("")
 
```

$\delta^{15}N$ signatures (and moose/ant consumption) are not associated with bear size or age in females. Larger bears should have greater metabolic demands and therefore require more protein, but there doesn't seem to be a pattern between $\delta^{15}N$ and size.

```{r, include=FALSE, eval=FALSE}

Repro15N.gamma<- brm(N15 ~reprocat+(1|fYR)+(1|bearID),
               data = Cort.Repro,
               family = Gamma(link = "log"),
              iter = 6000,
              thin = 10)
summary(Repro15N.gamma)
options(mc.cores = 1)
fit50 <- add_criterion(Repro15N.gamma, criterion = "loo")
gc()
print(fit50$criteria$loo)
Repro15N.LOOic <- fit50$criteria$loo$estimates[3,1]

```

While there was support for a statistical difference in $\delta^{15}N$ signatures between the two reproductive categories, I don't know that there is a real. biological difference here.

```{r, fig.width=8, fig.height=6, fig.cap="Box plot and histogram illustrating differences in cortisol and nitrogen between solitary females and females with dependent offspring"}

ggplot(data = Cort.Repro, aes(reprocat, N15))+
  geom_boxplot(aes(group=reprocat, fill=reprocat))+
  scale_fill_viridis(discrete = TRUE, begin = 0.17, end = 0.47)+
  theme(legend.position = "none")+

ggplot(data = Cort.Repro, aes(N15))+
  geom_histogram(aes(fill=reprocat), binwidth = 0.5*sd(Cort.Repro$N15))+
  scale_fill_viridis(discrete = TRUE, begin = 0.17, end = 0.47)
  

```

However, it may be that bears with higher $\delta^{15}N$ signatures are under higher metabolic demands as they process more nitrogen and travel between protein-rich foods.


```{r}

ggplot(data = Cort.Repro, aes(N15))+
  geom_histogram(binwidth = 0.5*sd(Cort.Repro$N15))

Int2.gamma <- brm(N15 ~1+(1|bearID),
               data = Cort.Repro,
               family = gaussian(link = "log"),
              iter = 6000,
              thin = 10)
summary(Int2.gamma)
options(mc.cores = 1)
fit52 <- add_criterion(Int2.gamma, criterion = "loo")
gc()
print(fit52$criteria$loo)
Int2.LOOic <- fit52$criteria$loo$estimates[3,1]


Trend15N.gamma<- brm(N15 ~year+(1|bearID),
               data = Cort.Repro,
               family = gaussian(link = "log"),
              iter = 6000,
              thin = 10)
summary(Trend15N.gamma)
options(mc.cores = 1)
fit51 <- add_criterion(Trend15N.gamma, criterion = "loo")
gc()
print(fit51$criteria$loo)
Trend15N.LOOic <- fit51$criteria$loo$estimates[3,1]

library(lme4)

Trend15N.freq <- lmer(N15~year+(1|bearID),
                       data = Cort.Repro,
                      REML = FALSE)
summary(Trend15N.freq)

```


```{r, include=FALSE}

ggplot(data = Cort.Repro, aes(year, N15))+
  geom_jitter(width = 0.2, height = 0.001, size=3, alpha=0.5)+
  geom_smooth(method = "lm")+
  
  ggplot(data = Cort.Repro, aes(N15, lnCORT))+
  geom_point(size=3, alpha=0.5)+
  geom_smooth(method = "lm")+
  
  ggplot(data = Cort.Repro, aes(year, lnCORT))+
  geom_jitter(width = 0.2, height = 0.001, size=3, alpha=0.5)+
  geom_smooth(method = "lm")


ggplot(data = Cort.Repro, aes(year, cort))+
  geom_jitter(aes(color=age), size=3, alpha=0.5, width = 0.15)+
  scale_color_viridis()

ggplot(data = Cort.Repro)+
  geom_histogram(aes(year), binwidth = 1, alpha=0.7)+
  geom_jitter(aes(year,cort, color=age), width = 0.15, size=4, alpha=0.7)+
  scale_color_viridis()+
  scale_y_continuous(expand = c(0,0))+
  scale_x_continuous(expand = c(0,0))

ggplot(data = Cort.Repro)+
  geom_histogram(aes(age), binwidth = 0.5*sd(Cort.Repro$age))+
  scale_y_continuous(expand = c(0,0))+
  scale_x_continuous(expand = c(0,0))


```


```{r, include=FALSE}

rm(fit1,fit2,fit3,fit4,fit5,
   CORTint.gauss,Log15N.gamma,Quad15N.gamma, Lin15N.gamma)


```


#### Condition


```{r, include=FALSE}

condition.model <- function(x){
  exp(1.75+(x*0.67)+((x^2)*-0.65))
}

new.Cond <- seq(min(Cort.Repro$Zcond), max(Cort.Repro$Zcond), length.out=100)

Cond.predcort <- condition.model(new.Cond)
Acond <- (new.Cond*sd(Cort.Repro$condition))+mean(Cort.Repro$condition)
cond.df <- as.data.frame(cbind(new.Cond, Cond.predcort,Acond))


```


```{r, fig.height=5, fig.width=5, fig.cap="Fitted relationship between body condition and cortisol with observed"}
ggplot(data = cond.df, aes(Acond, Cond.predcort))+
  geom_jitter(data = Cort.Repro, aes(condition,cort), alpha=0.5,
              width = 0.01, height =0.05 )+
  geom_line(lwd=1.2)+
  ylab("Cortisol")+
  xlab("Body Condition (mass/skull circumference)")+
  geom_text(label="beta (BC) = 0.67, SE= 0.19\nbeta (BC^2) = - 0.65, SE =0.19\n delta LOOaic = 10.1 ",
            x=1, y=25, size=4)+
  geom_vline(xintercept = 1.485)+
  scale_y_continuous(expand = c(0,0))

```

Bears in both the lowest and highest body condition had low cortisol concentrations. If cortisol is acting as an index of metabolic demands, then we would expect cortisol to decrease with body condition or be a quadratic that opens upwards rather than downwards.
  Cortisol peaks for bears in median body condition , approximately 1.49, but the relationship is pretty flat from 1.45 to 1.52. The majority of these bears (81%) are females with dependent offspring.

```{r, include=FALSE}

BC.bears <- subset(Cort.Repro, condition>1.449)
BC.bears <- subset(BC.bears, condition< 1.53)

ggplot(data = BC.bears, aes(condition))+
  geom_histogram(binwidth = 0.01)

ggplot(data = BC.bears, aes(year))+
  geom_histogram(binwidth = 1)

ggplot(data = BC.bears, aes(age))+
  geom_histogram(binwidth = 1)

ggplot(data = BC.bears, aes(cubsfirstcount))+
  geom_histogram(binwidth = 1)

ggplot(data = BC.bears, aes(C13.suess))+
  geom_histogram(binwidth = 0.5*sd(Cort.Repro$C13.suess))

ggplot(data = BC.bears, aes(N15))+
  geom_histogram(binwidth = 0.5*sd(Cort.Repro$N15))

ggplot(data = Cort.Repro, aes(N15))+
  geom_histogram(binwidth = 0.5*sd(Cort.Repro$N15))

ggplot(data = Cort.Repro, aes(cILI))+
  geom_histogram(binwidth = 1)

sd(Cort.Repro$condition)
mean(Cort.Repro$condition)
1.485-0.44

BadBears <- subset(Cort.Repro, condition<1.27)

Q <- palette(viridis(5))
Q <- palette(viridis(5))

```

While no clear pattern exists, bears at least 1 SD below peak condition are predominately young bears from around 2010.

```{r, fig.width=8, fig.height=6, fig.cap="distribution of age and year represented by bears in the poorest condition (greater than 2 SDs below the inflection point"}

ggplot(data = BadBears, aes(age))+
  geom_histogram(binwidth = 1, fill=Q[2])+
  scale_y_continuous(expand = c(0,0))+
  scale_x_continuous(expand = c(0,0))+
 
  
  
ggplot(data = BadBears, aes(year))+
  geom_histogram(binwidth = 1, fill=Q[3])+
  ylab("")+
  scale_y_continuous(expand = c(0,0))+
  scale_x_continuous(expand = c(0,0),
                     breaks = seq(1995,2015,5))
  

```

Theoretically, bears in the best condition have low cortisol because they have plenty of resources to meet metabolic demands and their bodies are under fewer stressors. Bears in lower body condition may have lower cortisol related to down regulation or genetic effects in which an under active HPA system also prevents important physiological process, resulting in lower body condition.

In summary, bears in the worst condition had lower cortisol, had masses ~45 kilos, head circumferences in the low 40's (cm) ranged in age 2-4, and occurred in years 2009-2011

#### Age

```{r, include=FALSE}

age.model <- function(x){
  exp(1.75+(x*0.49)+((x^2)*-0.39))
}

new.Age <- seq(min(Cort.Repro$Zage), max(Cort.Repro$Zage), length.out=100)

Age.predcort <- age.model(new.Age)
AAge <- (new.Age*sd(Cort.Repro$age))+mean(Cort.Repro$age)
age.df <- as.data.frame(cbind(new.Age, Age.predcort,AAge))


```


```{r, fig.height=5, fig.width=5, fig.cap="Fitted relationship between maternal age and hair cortisol concentration with observed values as points"}
ggplot(data = age.df, aes(AAge, Age.predcort))+
  geom_jitter(data = Cort.Repro, aes(age,cort), alpha=0.5,
              width = 0.2, height =0.05, size=3)+
  geom_line(lwd=1.2)+
  ylab("Cortisol")+
  xlab("Age")+
  geom_text(label="beta (AGE) = 0.49, SE= 0.08\nbeta (AGE^2) = - 0.39, SE =0.08\n delta LOOaic = 32.1 ",
            x=13, y=25, size=4)+
  scale_x_continuous(expand = c(0,0))+
  scale_y_continuous(expand = c(0,0))

```

cortisol increased with bear age until it peaked at approximately 10 years, then decrease.However, the data becomes more sparse for bears above 10, so the relationship may be more of a log-linear pseudo-threshold rather than a true quadratic. The difference between the log-linear and quadratic models were almost non-existent.
```{r, include=FALSE}
PQ <- palette(viridis((3), begin = 0.2, end = 0.85))
PQ <- palette(viridis((3), begin = 0.2, end = 0.85))

```


```{r, fig.width=8, fig.height=6,fig.cap="comparisons of the two quadratic relationships between cortisol and age (Panel A), condition (Panel C) and the relationship between those two quadratics (Panel B)"}

ggplot(data = Cort.Repro, aes(age, cort))+
  geom_jitter(width = 0.2, color=PQ[1], size=3, alpha=0.5)+
  geom_smooth(color=PQ[1], lwd=1.2)+
  scale_y_continuous(expand = c(0,0))+
  scale_x_continuous(expand = c(0,0))+
  geom_vline(xintercept = 10)+
  geom_text(label="A",
            size=4,
            x=21, y=30)+
  
  ggplot(data = Cort.Repro, aes(age,condition))+
  geom_jitter(width = 0.2, color=PQ[2],size=3, alpha=0.5)+
  geom_smooth(color=PQ[2], lwd=1.2)+
  scale_y_continuous(expand = c(0,0))+
  scale_x_continuous(expand = c(0,0))+
  geom_vline(xintercept = 10)+
  geom_hline(yintercept = 1.49)+
  geom_text(label="B",
            size=4,
            x=21, y=2.14)+
  
  ggplot(data = Cort.Repro, aes(condition, cort))+
  geom_jitter(color=PQ[3],size=3, alpha=0.5)+
  geom_smooth(color=PQ[3], lwd=1.2)+
  scale_y_continuous(expand = c(0,0))+
  scale_x_continuous(expand = c(0,0))+
  geom_vline(xintercept = 1.49)+
  geom_text(label="C",
            size=4,
            x=2.1, y=30)

```


```{r, include=FALSE, eval=FALSE}

rm(AAge,Acond,Ad15N,
     Gaussian.LOOic, LinAge.LOOic, LinCon.LOOic, Log15N.LOOic,LogAge.LOOic,
     Quad15N.LOOic, LogCon.LOOic,
   fit1, fit2,fit3)

```



#### Inter-litter Interval

```{r, include=FALSE, eval=FALSE}

LinILI.gamma<- brm(cort ~ZcILI+(1|fYR)+(1|bearID),
               data = Cort.Repro,
               family = Gamma(link = "log"),
              iter = 6000,
              thin = 10)
options(mc.cores = 1)
fit2 <- add_criterion(LinILI.gamma, criterion = "loo")
gc()
print(fit2$criteria$loo)
LincILI.LOOic <- fit2$criteria$loo$estimates[3,1]

Gamma.LOOic-LincILI.LOOic

summary(LinILI.gamma)

```


```{r, include=FALSE, eval=FALSE}
ILI.test.3 <- subset(Cort.Repro, cILI<4)

LinILI.gamma<- brm(cort ~ZcILI+(1|fYR)+(1|bearID),
               data = ILI.test.3,
               family = Gamma(link = "log"),
              iter = 6000,
              thin = 10)
options(mc.cores = 1)
fit2.2 <- add_criterion(LinILI.gamma, criterion = "loo")
gc()
print(fit2.2$criteria$loo)
LincILI.test3.LOOic <- fit2.2$criteria$loo$estimates[3,1]

Gamma.LOOic-LincILI.test3.LOOic

summary(LinILI.gamma)
mean(Cort.Repro$cort)

```


There is strong evidence for a relationship between inter-litter interval and hair cortisol. The model performed much better than the intercept only model and the credible interval did not contain zero.

```{r, include=FALSE}

ILI.model <- function(x){
  exp(1.76+(x*0.14))
}

new.ILI <- seq(min(Cort.Repro$ZcILI), max(Cort.Repro$ZcILI), length.out=100)

ILI.predcort <- ILI.model(new.ILI)
AILI <- (new.ILI*sd(Cort.Repro$cILI))+mean(Cort.Repro$cILI)
ILI.df <- as.data.frame(cbind(new.ILI, ILI.predcort,AILI))


```


```{r, fig.height=6, fig.width=6, fig.cap="Fitted relationship between Inter-litter interval and cortisol"}

ggplot(data = ILI.df, aes(AILI, ILI.predcort))+
  geom_jitter(data = Cort.Repro, aes(cILI,cort), alpha=0.5,
              width = 0.1, height =0.05, color="#453781FF" )+
  geom_line(lwd=1.2,color="#453781FF" )+
  ylab("Cortisol")+
  xlab("Inter-litter Interval")+
  geom_text(label="beta (ILI) = 0.11, SE= 0.02\n delta LOOaic = 15.8 ",
            x=3, y=25, size=5)

```


Bears that tried to reproduce 2 years in a row (ILI=0) had lower cortisol than bears that had longer intervals between confirmed breeding attempts. We know that bears must reach a critical threshold of fat for successful implantation. If cortisol is acting as an indicator of metabolic demand, bears with higher cortisol may be under greater demands and struggle to meet that threshold, thus reproducing less frequently. In retrospect, ILI would be the more appropriate response variable rather than cortisol (i.e., ILI~CORT rather than CORT ~ILI)


```{r, fig.width=6, fig.height=6, fig.cap="Relationship between body condition and inter-litter interval. Inter-litter interval is the number of years between reproductive events"}

ggplot(data = subset(Cort.Repro, cILI<4), aes(condition,cILI))+
  geom_jitter(height = 0.2)+
  scale_y_continuous(expand = c(0,0))+
  scale_x_continuous(expand = c(0,0))+
  ylab("Inter-litter interval")+
  xlab( "Female body condition (mass/head circumference)")
  
```

However there isn't a clear relationship between inter-litter interval and condition, like we might expect. If you squint, it looks like bears in better condition have longer intervals between breeding attempts, which is contrary to the previous point.

### Moderately intriguing results

#### Litter size

```{r, include=FALSE, eval=FALSE}

LinLS.gamma<- brm(cort ~Zlitsize+(1|fYR)+(1|bearID),
               data = Cort.Repro,
               family = Gamma(link = "log"),
              iter = 3000)
options(mc.cores = 1)
fit3 <- add_criterion(LinLS.gamma, criterion = "loo")
gc()
print(fit3$criteria$loo)
LinLS.LOOic <- fit3$criteria$loo$estimates[3,1]

Gamma.LOOic-LinLS.LOOic

summary(LinLS.gamma)

```

There is strong evidence for an effect of litter size on the brown bear hair cortisol. The model performed much better than the intercept only and the confidence interval did not contain zero

```{r, include=FALSE}

LS.model <- function(x){
  exp(1.74+(x*0.16))
}

new.LS <- seq(min(Cort.Repro$Zlitsize),
              max(Cort.Repro$Zlitsize), length.out=100)

LS.predcort <- LS.model(new.LS)
ALS <- (new.LS*sd(Cort.Repro$cubsfirstcount))+mean(Cort.Repro$cubsfirstcount)
LS.df <- as.data.frame(cbind(new.LS, LS.predcort,ALS))
Cort.Repro$fLS <- as.factor(Cort.Repro$cubsfirstcount)

```




```{r, fig.height=6, fig.width=6, fig.cap="fitted relationship between cortisol and litter size, with observed values as points"}

ggplot(data = LS.df, aes(ALS, LS.predcort))+
  geom_jitter(data = Cort.Repro, aes(cubsfirstcount,cort), alpha=0.5,
              width = 0.1, height =0.05, color="#238A8DFF")+
  geom_line(lwd=1.2,color="#238A8DFF")+
  ylab("Cortisol")+
  xlab("Litter size")+
  geom_text(label="beta (LS) = 0.16, SE= 0.02\n delta LOOaic = 45.2 ",
            x=3, y=25, size=5)

```

bears with larger litters tended to have higher cortisol values than bears with smaller litters. If, as we assume, cortisol is acting as an indicator of metabolic demands, this makes fantastic biological sense. Again, the sample size gets sparse at the extreme end of litter sizes, and may be biasing the relationship low.


```{r, fig.width=8, fig.height=6, fig.cap="Distribution of different litter sizes across different bear ages and body conditions"}

ggplot(data = Cort.Repro, aes(age))+
  geom_histogram(aes(fill=fLS), binwidth = 1)+
  scale_fill_viridis(discrete = TRUE, end = 0.9)+
  scale_y_continuous(expand = c(0,0))+
  scale_x_continuous(expand = c(0,0))+
  labs(fill="Litter size")+
  theme(legend.position = "none")+
  
  ggplot(data = Cort.Repro, aes(condition))+
  geom_histogram(aes(fill=fLS), binwidth = 0.5*sd(Cort.Repro$condition))+
  scale_fill_viridis(discrete = TRUE, end = 0.9)+
  scale_y_continuous(expand = c(0,0))+
  scale_x_continuous(expand = c(0,0))+
  labs(fill="Litter size")+
  ylab("")


```

Litter size tends to increase with age and has a normal distribution across body conditions



#### Parity

```{r, include=FALSE, eval=FALSE}

LinParity.gamma<- brm(cort ~Parity+(1|fYR)+(1|bearID),
               data = Cort.Repro,
               family = Gamma(link = "log"),
              iter = 3000)
options(mc.cores = 1)
fit5 <- add_criterion(LinParity.gamma, criterion = "loo")
gc()
print(fit5$criteria$loo)
LinParity.LOOic <- fit5$criteria$loo$estimates[3,1]

Gamma.LOOic-LinParity.LOOic

summary(LinParity.gamma)

Q <- palette(viridis(3))
Q <- palette(viridis(3))

```

There is strong evidence that cortisol differed between bears prior to reproduction, during their first reproductive event, and when they were multiparous. The model performed much better than the intercept only model and only one of the regression beta estimates had a credible intervals that slightly overlapped zero. 

```{r, fig.height=6, fig.width=7, fig.cap="Cortisol distribution between the three categories of parity: before first reproduction, primiparous (first time reproducing), and multiparous (multiple reproduction events)"}

ggplot(data = Cort.Repro, aes(Parity, cort))+
  geom_jitter(aes(color=Parity), width = 0.1, height = 0.01)+
  geom_boxplot(aes(fill=Parity), alpha=0.6)+
  ylab("Cortisol")+
  xlab("Parity")+
  geom_text(label="delta LOOaic = 53.6 ",
            x=2, y=25, size=5)+
  scale_fill_viridis(discrete = TRUE)+
    scale_color_manual(values = c(Q[1],Q[2],Q[3]),
                       breaks=c("M", "P","N"),
                       label=c("Multiparous", "Primiparous", "Before first repro"))+
  scale_fill_manual(values = c(Q[1],Q[2],Q[3]),
                       breaks=c("M", "P","N"),
                       label=c("Multiparous", "Primiparous", "Before first repro"))

```

Multiparous bears had the highest cortisol concentrations followed by primiparous bears, but there was only moderate support, as the 95% credible interval for the beta estimate slightly overlapped zero. Bears who had not reproduced (and may have died prior to doing so) had the lowest cortisol concentrations. 

The distribution of body condition was similar across the three categories, but multiparous bears tended to be in better condition than the other two categories.

```{r,fig.height=6, fig.width=8, fig.cap= "The distribution of age across the three categories of parity and the relationship between cort and age"}
ggplot(data = Cort.Repro, aes(age))+
  geom_histogram(aes(fill=Parity), binwidth = 1)+
  scale_fill_manual(values = c(Q[1],Q[2],Q[3]),
                       breaks=c("M", "P","N"),
                       label=c("Multiparous", "Primiparous", "No known repro"))+
  scale_y_continuous(expand = c(0,0))+
  scale_x_continuous(expand = c(0,0))+
  
  ggplot(data = Cort.Repro, aes(age,cort))+
  geom_jitter(width = 0.2, height = 0)+
  scale_y_continuous(expand = c(0,0))+
  scale_x_continuous(expand = c(0,0))
  
  
```


```{r,fig.height=6, fig.width=8, fig.cap="Distribution of maternal body condition (mass/head circumference) across the three categories of parity: no Prior to first reproduction, primiparous, and multiparous"}

ggplot(data = Cort.Repro, aes(condition))+
  geom_histogram(aes(fill=Parity), binwidth = 0.5*sd(Cort.Repro$condition))+
  scale_fill_manual(values = c(Q[1],Q[2],Q[3]),
                       breaks=c("M", "P","N"),
                       label=c("Multiparous", "Primiparous", "PFR"))+
  scale_y_continuous(expand = c(0,0))+
  scale_x_continuous(expand = c(0,0))

```


#### Repro Status

```{r, include=FALSE, eval=FALSE}

LinRS.gamma<- brm(cort ~reprocat+(1|fYR)+(1|bearID),
               data = Cort.Repro,
               family = Gamma(link = "log"),
              iter = 6000,
              thin = 10)
options(mc.cores = 1)
fit6 <- add_criterion(LinRS.gamma, criterion = "loo")
gc()
print(fit6$criteria$loo)
LinRS.LOOic <- fit6$criteria$loo$estimates[3,1]

Gamma.LOOic-LinRS.LOOic

summary(LinRS.gamma)

```


There is strong evidence for a difference in cortisol concentrations between females with dependent offspring and single females. The model performed better than the intercept only model and the beta estimate did not contain zero.

```{r, fig.height=6, fig.width=8, fig.cap="Cortisol distribution between the two reproductive categories, females with dependent offspring and solitary females"}

ggplot(data = Cort.Repro, aes(reprocat, cort))+
  geom_jitter(aes(color=reprocat), width = 0.1, height = 0.01)+
  geom_boxplot(aes(fill=reprocat), alpha=0.6)+
  ylab("Cortisol")+
  xlab("Reproductive Category")+
  geom_text(label="delta LOOaic = 54.1 ",
            x=2, y=25, size=4)+
    scale_color_manual(values = c(Q[1],Q[2]))+
  scale_fill_manual(values = c(Q[1],Q[2]))

```

Single females tended to have lower cortisol concentrations than females with dependent offspring.


```{r, fig.width=8, fig.height=6, fig.cap="Distribution of ange and maternal body condition between the different reproductive categories: females with dependent offspring and solitary females"}

ggplot(data = Cort.Repro, aes(age))+
  geom_histogram(aes(fill=reprocat), binwidth = 1)+
  scale_fill_manual(values = c(Q[1],Q[2]))+
  scale_y_continuous(expand = c(0,0))+
  scale_x_continuous(expand = c(0,0))+
  theme(legend.position = "none")+
  
  ggplot(data = Cort.Repro, aes(condition))+
  geom_histogram(aes(fill=reprocat), binwidth = 0.5*sd(Cort.Repro$condition))+
  scale_fill_manual(values = c(Q[1],Q[2]))+
  scale_y_continuous(expand = c(0,0))+
  scale_x_continuous(expand = c(0,0))+
  ylab("")
  

```

Single females tended to be younger females, likely before their first successful reproductive event. Our sample may be pretty biased between these two categories. Once a bear is collared, I don't believe they regularly recaptured unless they are accompanied by yearlings that need to be recaptured. So once a bear has begun to reproduce, they are more likely to be sampled when they are accompanied by offspring than when they are not. Hence, an unequal sampling scheme.

### Minimally interesting results

#### Carbon

```{r, include=FALSE, eval=FALSE}

Lind13C.gamma<- brm(cort ~Zd13C+(1|fYR)+(1|bearID),
               data = Cort.Repro,
               family = Gamma(link = "log"),
              iter = 3000)
summary(Lind13C.gamma)
options(mc.cores = 1)
fit1 <- add_criterion(Lind13C.gamma, criterion = "loo")
gc()
print(fit1$criteria$loo)
Lind13C.LOOic <- fit1$criteria$loo$estimates[3,1]

Gamma.LOOic-Lind13C.LOOic

summary(Lind13C.gamma)

```

There is moderate evidence for a relationship between $\delta^{13}C$ signatures and hair cortisol. The model performed slightly better than the intercept only model, and the confidence interval contained zero.

```{r, include=FALSE}

d13C.model <- function(x){
  exp(1.75+(x*-0.05))
}

new.d13C <- seq(min(Cort.Repro$Zd13C), max(Cort.Repro$Zd13C), length.out=100)

d13C.predcort <- d13C.model(new.d13C)
Ad13C <- (new.d13C*sd(Cort.Repro$C13.suess))+mean(Cort.Repro$C13.suess)
d13C.df <- as.data.frame(cbind(new.d13C, d13C.predcort,Ad13C))


```


```{r, fig.height=5, fig.width=5, fig.cap="Fitted relationship between carbon and cortisol with observed values as points"}

ggplot(data = d13C.df, aes(Ad13C, d13C.predcort))+
  geom_jitter(data = Cort.Repro, aes(C13.suess,cort), alpha=0.5,
              width = 0.1, height =0.05 )+
  geom_line(lwd=1.2)+
  ylab("Cortisol")+
  xlab(expression(paste(delta^13, "C (\u2030)", sep = "")))+
  geom_text(label="beta (C13) = - 0.05, SE= 0.03\n delta LOOaic = 1.9 ",
            x=-22, y=25, size=4)

```


```{r,fig.width=8,fig.height=6, fig.cap= "Relationships between Carbon and cort through time"}

ggplot(data = Cort.Repro, aes(year,C13.suess))+
  geom_jitter(width=0.2)+
  scale_y_continuous(expand = c(0,0))+
  scale_x_continuous(expand = c(0,0))+
  geom_smooth(method = "lm")+

  ggplot(data = Cort.Repro, aes(year,lnCORT))+
  geom_jitter(width=0.2)+
  scale_y_continuous(expand = c(0,0))+
  scale_x_continuous(expand = c(0,0))+
    geom_smooth(method = "lm")


```


While there is some support for an effect of Carbon, I don't see any biological reason that it would affect cortisol and both cortisol and carbon are correlated with year, which I suspect is driving this relationship.

#### Length Maternal care


```{r, include=FALSE, eval=FALSE}

LinLMC.gamma<- brm(cort ~LMC+(1|fYR)+(1|bearID),
               data = Cort.Repro,
               family = Gamma(link = "log"),
              iter = 3000)
options(mc.cores = 1)
fit4 <- add_criterion(LinLMC.gamma, criterion = "loo")
gc()
print(fit4$criteria$loo)
LinLMC.LOOic <- fit4$criteria$loo$estimates[3,1]

Gamma.LOOic-LinLMC.LOOic

summary(LinLMC.gamma)

```

Again, strong evidence for an effect, with the LMC model out performing the intercept only model and confidence intervals not overlapping zero. However, there are many bears in the "unknown" category and I am a bit suspicious of these model results. I think I should exclude the covariate from further analysis.


```{r, fig.height=5.5, fig.width=7.5, fig.cap="Cortisol distribution between the four categories of length of maternal care"}

ggplot(data = Cort.Repro, aes(LMC, cort))+
  geom_jitter(aes(color=LMC), width = 0.1, height = 0.01)+
  geom_boxplot(aes(fill=LMC), alpha=0.6)+
  ylab("Cortisol")+
  xlab("Length Maternal Care")+
  geom_text(label="delta LOOaic = 60.5 ",
            x=3, y=25, size=4)+
  scale_fill_viridis(discrete = TRUE)+
    scale_color_viridis(discrete = TRUE)+
  labs(fill="Length of \nmaternal care", 
       color="Length of \nmaternal care")

```


## Cortisol univariate model summary

None of the variables that I tested failed to outperform the intercept only model.

Length of maternal care explained the most variation in the data, followed by parity, litter size, age, $\delta^{15}N$, Inter litter interval, body condition, and $\delta^{13}C$

As a result, I will use all continuous variables in the next phase of modelling, which is the PCA analysis and the PLSR.

It is evident in all of my graphs that individually each covariate does a fairly poor job at explaining variation in cortisol. Specifically, none of the models are able to predict cortisol values greater than 7-9 pg/mg, which is strange given that my observed values range from 2 to 39. Personally, I think this indicates that many of these co-linear confounded variables act together in additive or multiplicative ways.

# Nitrogen as response variable

## Intercept only

```{r}

Nitroint.gauss<- brm(Zd15N ~1+(1|fYR)+(1|bearID),
               data = Cort.Repro,
               family = gaussian,
              iter = 6000,
              thin = 10)
summary(Nitroint.gauss)
options(mc.cores = 1)
fitN1 <- add_criterion(Nitroint.gauss, criterion = "loo")
gc()
print(fitN1$criteria$loo)
NitroGaussian.LOOic <- fitN1$criteria$loo$estimates[3,1]

launch_shinystan(Nitroint.gauss)
plot(Nitroint.gauss)
plot(loo(Nitroint.gauss, cores = getOption("mc.cores", 1)))

```

I need to check the residuals/predictive errors for this intercept only model
```{r}
Int.error <- predictive_error(Nitroint.gauss)

str(Int.error)



```


## Covariates and explanations of hypothesized relationships

### Non-linear relationships

#### Cortisol
 Cortisol is an indicator of metabolic demands or chronic, acute stressors. As metabolic demands increase, bears may need to start catabolizing their own protein (muscle and organs) to meet demands. If this is the case, we may expect to see a positive linear relationship between cortisol and $\delta^{15}N$:
 $$\mu(\delta^{15}N)= \beta_0+\beta_1*cortisol $$
 
However, metabolic demands and the body's ability to cope with those demands may not increase linearly. Animals may have a threshold of tolerable stressors beyond which cortisol rapidly increases, resulting in a positive pseudo-threshold (log linear) relationship, $\mu(\delta^{15}N)= e^{\beta_0+\beta_1*cortisol}$ or perhaps even a quadratic $\mu(\delta^{15}N)=\beta_0+\beta_1*cortisol+\beta_2*cortisol^2$.

While foods in higher trophic levels have higher concentrations of nitrogen and tend to to be more energetically dense, they also tend to me more rare on the landscape. Therefore, as energetic demand increases, bears may prioritize carbon-based foods that can rapidly be converted to sugar, thus reducing $\delta^{15}N$ in either a linear or pseudo-threshold (log linear) relationship.

Below I explore the relationship between $\delta^{15}N$ and cortisol to determine what shape (linear, log-linear, or quadratic).

```{r, include=FALSE, eval=FALSE}

##### Linear
LinCORT.gauss<- brm(Zd15N~Zcort+(1|fYR)+(1|bearID),
               data = Cort.Repro,
               family = gaussian(),
               iter = 6000,
               thin = 10)

summary(LinCORT.gauss)
options(mc.cores = 1)
fitN3 <- add_criterion(LinCORT.gauss, criterion = "loo")
gc()
print(fitN3$criteria$loo)
CORT.Nlin.LOOic <- fitN3$criteria$loo$estimates[3,1]


##### Log-Linear

LogCORT.gauss<- brm(Zd15N~Zcortln+(1|fYR)+(1|bearID),
               data = Cort.Repro,
               family = gaussian(),
              iter = 6000,
              thin = 10)
summary(LogCORT.gauss)
options(mc.cores = 1)
fitN4 <- add_criterion(LogCORT.gauss, criterion = "loo")
gc()
print(fitN4$criteria$loo)
CORT.Nlog.LOOic <- fitN4$criteria$loo$estimates[3,1]

##### Quadratic

QuadCORT.gauss<- brm(Zd15N~Zcort+Zcortsq+(1|fYR)+(1|bearID),
               data = Cort.Repro,
               family = gaussian(),
              iter = 6000,
              thin = 10)
summary(QuadCORT.gauss)
options(mc.cores = 1)
fitN5 <- add_criterion(QuadCORT.gauss, criterion = "loo")
gc()
print(fitN5$criteria$loo)
CORT.Nquad.LOOic <- fitN5$criteria$loo$estimates[3,1]

```



```{r, include=FALSE, eval=FALSE}
print(CORT.Nlin.LOOic)
print(CORT.Nlog.LOOic)
print(CORT.Nquad.LOOic)
print(NitroGaussian.LOOic)

summary(QuadCORT.gauss)

print(NitroGaussian.LOOic-CORT.Nquad.LOOic)

print(CORT.Nlog.LOOic-CORT.Nquad.LOOic)

```

Not surprising, given the cortisol analysis I had previously conducted, the quadratic relationship between cortisol and $\delta^{15}N$ had the most support. It had a $\Delta LOOic = 33.22$ units lower than the intercept only model and  13.94 $\Delta LOOic$ units lower than the next-best structure (log-linear). The underlying model can be written as:

$$\delta^{15}N= 0.01+(-0.16*cortisol)+(0.26*cortisol^2)$$

Not only did the model explain more variation than the intercept only, but neither of the 95% credible intervals for the $\beta$ estimates contained zero

```{r}

Nitro.Cort <- function(x){
  0.01+(-0.16*x)+(0.26*x^2)
}

New.Ncort <- seq(min(Cort.Repro$Zcort),
                 max(Cort.Repro$Zcort),
                 length.out=273)
New.Ncort

PredNitro.Cort <- Nitro.Cort(New.Ncort)

plot(New.Ncort,PredNitro.Cort)

ANew.Ncort <- (New.Ncort*sd(Cort.Repro$cort))+
  mean(Cort.Repro$cort)
APredNitro.CORT <- (PredNitro.Cort*sd(Cort.Repro$N15))+mean(Cort.Repro$N15)

Nitro.Cort.DF <- as.data.frame(cbind(New.Ncort,
                                     ANew.Ncort,
                                     PredNitro.Cort,
                                     APredNitro.CORT,
                                     Cort.Repro$cort,
                                     Cort.Repro$N15,
                                     Cort.Repro$Zd15N,
                                     Cort.Repro$Zcort))
```


```{r, fig.height=5, fig.width=5, fig.cap="Fitted relationship of cortisol predicting nitrogen signatures with observed values as points"}

ggplot(data = Nitro.Cort.DF, aes(ANew.Ncort,APredNitro.CORT))+
  geom_line(lwd=1.2)+
  geom_point(aes(V5,V6), size=2, alpha=0.45)+
  ylab(expression(paste(delta^15, "N (\u2030)", sep = "")))+
  xlab("cortisol  ( pg/mg )")+
  scale_y_continuous(expand = c(0,0))+
  scale_x_continuous(expand = c(0,0))

```

#### Age

Bear age may have large effects on diet, and therefore $\delta^{15}N$ signatures as metabolism, energetic demands, and social dominance change through a bear's life. 
  Under one scenario, young bears (2-4 ish) are still rapidly growing and need protein to build muscle, hair, and organs. Thus, they may forage heavily on protein-rich foods, elevating their $\delta^{15}N$ signature. This relationship could manifest as either a negative linear trend in which protein demands decrease at a constant rate each year. It may also be log-linear, in which demands rapidly decrease over the first years of a bears life and then hit a pseudo-threshold around 8 when adult size is approximately reached.
  In contrast to this hypothesis, as bears get older, better social status, hunting experience, and landscape knowledge may improve a bear's ability to exploit certain foods over others. Thus, $\delta^{15}N$ signatures may increase with age. I expect that this relationship may manifest it's self as a positive linear or log-linear relationship. The linear relationship would account for a steady accumulation of knowledge and status each year. The log-linear relationship would result from a rapid accumulation over the first years of life, eventually tapering to a threshold. 
  **Note**, there are several twists to this relationship that need to be considered. First, offspring have higher $\delta^{15}N$ signatures than dams, therefore in the youngest age categories, newly independent bears may have an inflated nitrogen signature related to nursing rather than foraging decisions or availability. Thus, the relationship could also be represented by a quadratic, where $\delta^{15}N declines for a year or two before rapidly increasing with age. Second, the above hypotheses do not account for changes in reproductive status, which will inevitably affect protein demands and foraging choices.
  
Below I explore the relationship between $\delta^{15}N$ and age to determine what shape (linear, log-linear, or quadratic).

```{r, include=FALSE, eval=FALSE}

##### Linear
LinAge.gauss<- brm(Zd15N~Zage+(1|fYR)+(1|bearID),
               data = Cort.Repro,
               family = gaussian(),
               iter = 6000,
               thin = 10)

summary(LinAge.gauss)
options(mc.cores = 1)
fitN6 <- add_criterion(LinAge.gauss, criterion = "loo")
gc()
print(fitN6$criteria$loo)
Age.Nlin.LOOic <- fitN6$criteria$loo$estimates[3,1]


##### Log-Linear

LogAge.gauss<- brm(Zd15N~Zageln+(1|fYR)+(1|bearID),
               data = Cort.Repro,
               family = gaussian(),
              iter = 6000,
              thin = 10)
summary(LogAge.gauss)
options(mc.cores = 1)
fitN7 <- add_criterion(LogAge.gauss, criterion = "loo")
gc()
print(fitN7$criteria$loo)
Age.Nlog.LOOic <- fitN7$criteria$loo$estimates[3,1]

##### Quadratic

QuadAge.gauss<- brm(Zd15N~Zage+Zagesq+(1|fYR)+(1|bearID),
               data = Cort.Repro,
               family = gaussian(),
              iter = 6000,
              thin = 10)
summary(QuadAge.gauss)
options(mc.cores = 1)
fitN8 <- add_criterion(QuadAge.gauss, criterion = "loo")
gc()
print(fitN8$criteria$loo)
Age.Nquad.LOOic <- fitN8$criteria$loo$estimates[3,1]

```



```{r, include=FALSE, eval=FALSE}
print(Age.Nlin.LOOic)
print(Age.Nlog.LOOic)
print(Age.Nquad.LOOic)
print(NitroGaussian.LOOic)

summary(QuadAge.gauss)

print(NitroGaussian.LOOic-Age.Nquad.LOOic)

print(Age.Nlog.LOOic-Age.Nquad.LOOic)

```

Based on the model comparison, the quadratic relationship was the best one describing the affect of age on $\delta^{15}N$ signatures. The quadratic model explained more variation in the data than the intercept only model ($\Delta LOOic = 5.8$) and the 95% credible intervals for both beta estimates exclude zero. However, the quadratic relationship barely out-performed the log linear model ($\Delta LOOic = 0.54$), which I interpret to mean there is only moderate support for the quadratic. This is likely do to decreasing sample sizes for bears older than 10 years, and the true shape of the relationship at the upper end of age is unclear.


```{r}

Nitro.Age <- function(x){
  0.03+(-0.51*x)+(0.50*x^2)
}

New.Nage <- seq(min(Cort.Repro$Zage),
                 max(Cort.Repro$Zage),
                 length.out=273)

PredNitro.Age <- Nitro.Age(New.Nage)

ANew.NAge <- (New.Nage*sd(Cort.Repro$age))+
  mean(Cort.Repro$age)
APredNitro.Age <- (PredNitro.Age*sd(Cort.Repro$N15))+
  mean(Cort.Repro$N15)

Nitro.Age.DF <- as.data.frame(cbind(New.Nage,
                                     ANew.NAge,
                                     PredNitro.Age,
                                     APredNitro.Age,
                                     Cort.Repro$cort,
                                     Cort.Repro$N15,
                                     Cort.Repro$Zd15N,
                                     Cort.Repro$Zage))
```


```{r, fig.height=5, fig.width=5, fig.cap="Fitted relationship of age predicting nitrogen signatures with observed values as points"}

ggplot(data = Nitro.Age.DF, aes(ANew.NAge,APredNitro.Age))+
  geom_line(lwd=1.2)+
  geom_point(aes(V5,V6), size=2, alpha=0.45)+
  ylab(expression(paste(delta^15, "N (\u2030)", sep = "")))+
  xlab("Bear age")+
  scale_y_continuous(expand = c(0,0))+
  scale_x_continuous(expand = c(0,0))

```

#### Female body condition

Body condition is a continuous variable calculated by dividing mass by skull circumference. In this way, it helps to control for structural size differences between bears skewing mass. In this way it attempts to measure stored resources, such as fat, lean mass, and organ tissues. Bear with more energy stores are likely to be foraging at higher trophic levels, thus The relationship may be a positive linear relationship. We may also see body condition increase with increasing $\delta^{15}N$ signatures to a certain threshold, and then plateau in a log-linear relationship. 


```{r, include=FALSE, eval=FALSE}

##### Linear
LinBC.gauss<- brm(Zd15N~Zcond+(1|fYR)+(1|bearID),
               data = Cort.Repro,
               family = gaussian(),
               iter = 6000,
               thin = 10)
options(mc.cores = 1)
fitN11 <- add_criterion(LinBC.gauss, criterion = "loo")
gc()
print(fitN11$criteria$loo)
BC.Nlin.LOOic <- fitN11$criteria$loo$estimates[3,1]


##### Log-Linear

LogBC.gauss<- brm(Zd15N~Zcondln+(1|fYR)+(1|bearID),
               data = Cort.Repro,
               family = gaussian(),
              iter = 6000,
              thin = 10)
options(mc.cores = 1)
fitN11 <- add_criterion(LogBC.gauss, criterion = "loo")
gc()
print(fitN11$criteria$loo)
BC.Nlog.LOOic <- fitN7$criteria$loo$estimates[3,1]

```



```{r, include=FALSE, eval=FALSE}
print(BC.Nlin.LOOic)
print(BC.Nlog.LOOic)
print(NitroGaussian.LOOic)

summary(LinBC.gauss)

print(NitroGaussian.LOOic-BC.Nlin.LOOic)

print(BC.Nlog.LOOic-BC.Nlin.LOOic)

```

The linear model performed better than the log-linear model ($\Delta LOOic = 14.0$).

```{r}

Nitro.BC <- function(x){
  0.02+(0.25*x)
}

New.Nbc <- seq(min(Cort.Repro$Zcond),
                 max(Cort.Repro$Zcond),
                 length.out=273)

PredNitro.BC <- Nitro.BC(New.Nbc)

ANew.Nbc <- (New.Nbc*sd(Cort.Repro$condition))+
  mean(Cort.Repro$condition)
APredNitro.BC <- (PredNitro.BC*sd(Cort.Repro$N15))+
  mean(Cort.Repro$N15)

Nitro.Cond.DF <- as.data.frame(cbind(New.Nbc,
                                     ANew.Nbc,
                                     PredNitro.BC,
                                     APredNitro.BC,
                                     Cort.Repro$condition,
                                     Cort.Repro$N15,
                                     Cort.Repro$Zd15N,
                                     Cort.Repro$Zcond))
```


```{r, fig.height=5, fig.width=5, fig.cap="Fitted relationship of female body condition predicting nitrogen signatures with observed values as points"}

ggplot(data = Nitro.Cond.DF, aes(ANew.Nbc,APredNitro.BC))+
  geom_line(lwd=1.2)+
  geom_point(aes(V5,V6), size=2, alpha=0.45)+
  ylab(expression(paste(delta^15, "N (\u2030)", sep = "")))+
  xlab("Female body condition (kg/cm)")+
  scale_y_continuous(expand = c(0,0))+
  scale_x_continuous(expand = c(0,0))

```


There is evidence for a positive relationship between body condition and $\delta^{15}N$ signatures. The model with the effect of body condition explained more variation in the data than the intercept alone ($\Delta LOOic = 19.3$) and 95% credible intervals around $\hat\beta_{COND}$ did not contain zero. 

### linear relationships

#### Year
Year can function as either a categorical variable accounting for annual environmental variation that is unaccounted for in the model related to the millions of environmental variables that are unmeasured. It can also be modeled as a continuous variable to test for a temporal trend. This is a bit problematic with mt data because I do not have an even sampling distribution across years:

```{r, fig.height=5, fig.width=5, fig.cap="Distribution of sample sizes by year"}

ggplot(data = Cort.Repro, aes(year))+
  geom_histogram(binwidth = 1)+
  scale_y_continuous(expand = c(0,0))+
  scale_x_continuous(expand = c(0,0))

```

And while the sample distribution actually doesn't look too bad across years, we are missing data for 2013, which is being processed in Canada. 

I expect $\delta^{15}N$ values to vary annually driven by natural variation in production of moose, ants, and berries, which will naturally alter diet and stable isotope signatures. If modeled as a trend, there is a possibility that $\delta^{15}N signatures will follow moose densities, increasing to a peak early in the time series, then slowly decreasing as hunting pressure increased and moose densities decreased. 

for now, I only model year as a categorical variable as a random intercept in all models.

#### Litter Size

Litter size is a continuous covariate denoting how many cubs were initially seen after den emergence. Each additional cub a female produces increases her energetic and protein demands. While there is some wiggle room in this relationship mediated by a trade-off between cub number and size (quantity vs. quality) you will always need a minimum amount of protein to build a bear and two viable bear cubs will require more than a single viable bear cub. The number of cubs that make it to den emergence should be related to available maternal resources. Mothers with higher $\delta^{15}N$ signatures should have more stored protein to invest in larger litters. Alternatively, females with larger litters may become depleted in $\delta^{15}N$ as they invest more of their own protein in cub growth. Thus, the relationship between litter size and $\delta^{15}N$ may be positive or negative linear.  

```{r, include=FALSE, eval=FALSE}

NitroLitSize.gauss<- brm(Zd15N~Zlitsize+(1|fYR)+(1|bearID),
               data = Cort.Repro,
               family = gaussian(),
               iter = 6000,
               thin = 10)

options(mc.cores = 1)
fitN10 <- add_criterion(NitroLitSize.gauss, criterion = "loo")
gc()
print(fitN10$criteria$loo)
LitSize.N.LOOic <- fitN10$criteria$loo$estimates[3,1]

```



```{r, include=FALSE, eval=FALSE}

print(NitroGaussian.LOOic-LitSize.N.LOOic)

summary(NitroLitSize.gauss)

```
There is strong evidence that litter size has a negative relationship with $\delta^{15}N$ signatures. The model with the effect of litter size explained more variation in the data than the intercept ony model and the 95% credible interval for $\hat\beta_{LITTER}$ did not contain zero.

```{r}

Nitro.Litter <- function(x){
  0.02+(-0.23*x)
}

New.Nlitter <- seq(min(Cort.Repro$Zlitsize),
                 max(Cort.Repro$Zlitsize),
                 length.out=273)

PredNitro.Litter <- Nitro.Litter(New.Nlitter)

ANew.Nlitter <- (New.Nlitter*sd(Cort.Repro$cubsfirstcount))+
  mean(Cort.Repro$cubsfirstcount)
APredNitro.Litter <- (PredNitro.Litter*sd(Cort.Repro$N15))+
  mean(Cort.Repro$N15)

Nitro.Litter.DF <- as.data.frame(cbind(New.Nlitter,
                                     ANew.Nlitter,
                                     PredNitro.Litter,
                                     APredNitro.Litter,
                                     Cort.Repro$cubsfirstcount,
                                     Cort.Repro$N15,
                                     Cort.Repro$Zd15N,
                                     Cort.Repro$Zlitsize))
```


```{r, fig.height=5, fig.width=5, fig.cap="Fitted relationship of litter size predicting nitrogen signatures with observed values as points"}

ggplot(data = Nitro.Litter.DF, aes(ANew.Nlitter,APredNitro.Litter))+
  geom_line(lwd=1.2)+
  geom_jitter(aes(V5,V6), size=2, alpha=0.45, width = 0.1)+
  ylab(expression(paste(delta^15, "N (\u2030)", sep = "")))+
  xlab("Litter size")+
  scale_y_continuous(expand = c(0,0))+
  scale_x_continuous(expand = c(0,0))

```


### Categorical Relationships

#### Reproductive status

Reproductive status is a binomial categorical variable noting whether a bear is solitary or accompanied by dependent offspring. Reproductive status may change diet and $\delta^{15}N$ signatures as metabolic demands change. Females reproducing will need more protein to support cub growth in utero and postpardum than females who are not reproducing. Thus, $\delta^{15}N$ may be higher on females with offspring.
  However, offspring are vulnerable to infanticide from male bears, thus females with offspring tend to alter their movements and behavior to mitigate this risk. Thus, females with dependent offspring may forgo foraging on protein-rich foods and have $\delta^{15}N$ signatures lower than independent females. 
  Offspring also tend to be enriched in $\delta^{15}N$ relative to dams. Mothers may preferentially route $^{15}N$ to milk while lactating. This would mean that if hypothesis 1 above is true, we might expect these effects to cancel one another out and females with dependent offspring to have $\delta^{15}N$ similar to those of solitary females. If hypothesis 2 above is correct, we would expect these to work synergystically and females with dependent offspring would have $\delta^{15}$ much lower than solitary females. 
  Reproductive status is also going to interact with other variables, such as age, size, body condition, and cortisol)

```{r, include=FALSE, eval=FALSE}

NitroRepro.gauss<- brm(Zd15N~reprocat+(1|fYR)+(1|bearID),
               data = Cort.Repro,
               family = gaussian(),
               iter = 6000,
               thin = 10)

summary(NitroRepro.gauss)
options(mc.cores = 1)
fitN9 <- add_criterion(NitroRepro.gauss, criterion = "loo")
gc()
print(fitN9$criteria$loo)
ReproCat.N.LOOic <- fitN9$criteria$loo$estimates[3,1]

```



```{r, include=FALSE, eval=FALSE}

print(NitroGaussian.LOOic-ReproCat.N.LOOic)

summary(NitroRepro.gauss)

```

There is evidence for a difference in $\delta^{15}N$ signatures between the two reproductive categories. The model including reproductive category described more variation in the data than the intercept only($\Delta LOOic = 19.6$) and the 95% credible intervals for the beta estimates did not contain zero.

```{r, fig.height=5, fig.width=5, fig.cap="Differences in Nitrogen signatures between reproductive categories"}

ggplot(data = Cort.Repro, aes(reprocat,N15))+
  geom_jitter(width = 0.01, size=2, alpha=0.45, aes(color=reprocat))+
  geom_boxplot(aes(group=reprocat, fill=reprocat), alpha=0.6)+
  scale_color_manual(values = c(PP[6], PP[8]),
                     breaks = c("Sfem","Wcubs"),
                     labels=c("Single female","With offspring"))+
  scale_fill_manual(values = c(PP[6], PP[8]),
                     breaks = c("Sfem","Wcubs"),
                     labels=c("Single female","With offspring"))+
  ylab(expression(paste(delta^15, "N (\u2030)", sep = "")))+
  xlab("Reproductive category")+
  labs(fill="Reproductive category", color="Reproductive category")+
  scale_x_discrete(breaks=c("Sfem", "Wcubs"),
                   labels=c("Single females","With cubs"))

```

Single females had higher $\delta^{15}N$ signatures than females with offspring, which isn't surprising because we know that females with cubs behave and forage differently than other demographic classes due to the risk of infanticide.


## Interpretaion of univariate models

### Most intriguing results

### Moderately intriguing results

### Minimally interesting results


